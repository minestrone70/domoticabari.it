<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lighting Control RGBW</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #050505; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .card { background: #111; border: 1px solid #222; border-radius: 28px; position: relative; }
        .input-dark { background: #1a1a1a; border: 1px solid #333; color: white; border-radius: 12px; }
        .tab-active { background: #3b82f6; color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
        
        .led { width: 14px; height: 14px; border-radius: 50%; position: absolute; top: 24px; right: 24px; transition: background-color 0.3s; }
        .led-off { background-color: #333; }
        .led-ok { background-color: #22c55e; }
        .led-ko { background-color: #ef4444; }

        .toggle-on { background: #3b82f6; color: white; }
        .toggle-off { background: #1e293b; color: #64748b; }
        
        /* Stili Slider Colorati */
        input[type="range"] { -webkit-appearance: none; height: 6px; border-radius: 5px; background: #222; outline: none; }
        #range-R::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #ef4444; border-radius: 50%; cursor: pointer; }
        #range-G::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #22c55e; border-radius: 50%; cursor: pointer; }
        #range-B::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #3b82f6; border-radius: 50%; cursor: pointer; }
        #range-W::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #ffffff; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="max-w-md w-full">
        <nav class="flex flex-wrap gap-2 p-1.5 bg-white/5 rounded-2xl mb-6">
            <button onclick="switchDevice('driveway')" id="btn-driveway" class="flex-1 min-w-[100px] py-3 rounded-xl text-[10px] font-bold uppercase tracking-wider transition-all">Driveway</button>
            <button onclick="switchDevice('ingresso')" id="btn-ingresso" class="flex-1 min-w-[100px] py-3 rounded-xl text-[10px] font-bold uppercase tracking-wider transition-all">Ingresso</button>
            <button onclick="switchDevice('chestnut')" id="btn-chestnut" class="flex-1 min-w-[100px] py-3 rounded-xl text-[10px] font-bold uppercase tracking-wider transition-all text-slate-500">Chestnut</button>
        </nav>

        <div class="card p-8 shadow-2xl space-y-8">
            <div id="conn-led" class="led led-off"></div>

            <header class="text-center">
                <h2 id="display-name" class="text-2xl font-bold text-white tracking-tight italic">--</h2>
                <p id="display-host" class="text-[9px] font-mono text-blue-500/40 uppercase mt-2 tracking-widest"></p>
                
                <div class="mt-6 flex flex-col gap-4 items-center">
                    <button id="main-toggle" onclick="toggleRelay()" class="w-full py-3 rounded-2xl text-[11px] font-black uppercase tracking-[0.2em] border border-white/5 transition-all opacity-50" disabled>
                        Interruttore
                    </button>
                    
                    <div id="tasmota-controls" class="hidden w-full space-y-5 pt-4 border-t border-white/5">
                        <h3 class="text-[10px] font-bold uppercase tracking-[0.2em] text-slate-500 text-left">Mixer Canali RGBW</h3>
                        
                        <div class="space-y-4">
                            <div class="flex items-center gap-4">
                                <span class="text-[10px] font-bold text-red-500 w-4">R</span>
                                <input type="range" id="range-R" min="0" max="255" value="0" class="flex-1" oninput="updateRGBW()">
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-[10px] font-bold text-green-500 w-4">G</span>
                                <input type="range" id="range-G" min="0" max="255" value="0" class="flex-1" oninput="updateRGBW()">
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-[10px] font-bold text-blue-500 w-4">B</span>
                                <input type="range" id="range-B" min="0" max="255" value="0" class="flex-1" oninput="updateRGBW()">
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-[10px] font-bold text-white w-4">W</span>
                                <input type="range" id="range-W" min="0" max="255" value="255" class="flex-1" oninput="updateRGBW()">
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            
            <div class="space-y-6 pt-4 border-t border-white/5">
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold uppercase text-slate-500">Accensione</label>
                        <select id="on_type" class="input-dark w-full p-3 text-sm outline-none">
                            <option value="sun">Tramonto</option>
                            <option value="time">Ora</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold uppercase text-slate-500">&nbsp;</label>
                        <input id="on_time" type="time" class="input-dark w-full p-3 text-sm hidden">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold uppercase text-slate-500">Spegnimento</label>
                        <select id="off_type" class="input-dark w-full p-3 text-sm outline-none">
                            <option value="time">Ora</option>
                            <option value="sun">Alba</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold uppercase text-slate-500">&nbsp;</label>
                        <input id="off_time" type="time" value="01:00" class="input-dark w-full p-3 text-sm">
                    </div>
                </div>
            </div>

            <button onclick="applySettings()" class="w-full bg-blue-600 hover:bg-blue-500 py-5 rounded-2xl font-bold text-white shadow-lg uppercase text-[10px] tracking-widest transition-all">
                Salva Programmazione
            </button>
            <div id="status-msg" class="text-center text-[10px] font-bold uppercase tracking-widest min-h-[1.5em] text-slate-600"></div>
        </div>
    </div>

    <script>
        const DEVICES = {
            driveway: { name: "Luci Driveway", host: "shellyplus1-08b61fcfed68.local", type: "shelly" },
            ingresso: { name: "Luci Ingresso", host: "shellyplus1-08b61fcfdcec.local", type: "shelly" },
            chestnut: { name: "Luci Chestnut Hill", host: "172.16.0.xx", type: "tasmota" }
        };

        let currentKey = null;
        let abortCtrl = null;

        document.getElementById('on_type').onchange = (e) => document.getElementById('on_time').classList.toggle('hidden', e.target.value === 'sun');
        document.getElementById('off_type').onchange = (e) => document.getElementById('off_time').classList.toggle('hidden', e.target.value === 'sun');

        async function switchDevice(key) {
            if (abortCtrl) abortCtrl.abort();
            abortCtrl = new AbortController();
            currentKey = key;
            const dev = DEVICES[key];
            
            document.getElementById('display-name').innerText = dev.name;
            document.getElementById('display-host').innerText = dev.host;
            document.getElementById('tasmota-controls').classList.toggle('hidden', dev.type !== 'tasmota');
            
            const mainToggle = document.getElementById('main-toggle');
            mainToggle.disabled = true;
            mainToggle.classList.add('opacity-50');

            Object.keys(DEVICES).forEach(k => document.getElementById(`btn-${k}`).className = `flex-1 min-w-[100px] py-3 rounded-xl text-[10px] font-bold uppercase tracking-wider transition-all ${k === key ? 'tab-active' : 'text-slate-500 hover:text-white'}`);
            
            const led = document.getElementById('conn-led');
            led.className = "led led-off";

            try {
                const url = dev.type === 'shelly' ? `http://${dev.host}/rpc` : `http://${dev.host}/cm?cmnd=Power`;
                const body = dev.type === 'shelly' ? JSON.stringify({id:1, method:"Switch.GetStatus", params:{id:0}}) : null;
                const res = await fetch(url, { method: dev.type === 'shelly' ? 'POST' : 'GET', body, signal: abortCtrl.signal });
                const data = await res.json();
                updateToggleUI(dev.type === 'shelly' ? data.result.output : data.POWER === "ON");
                led.className = "led led-ok";
                mainToggle.disabled = false;
                mainToggle.classList.remove('opacity-50');
            } catch (e) {
                if (e.name !== 'AbortError') led.className = "led led-ko";
            }
        }

        // FUNZIONE MIXER RGBW
        async function updateRGBW() {
            if (DEVICES[currentKey].type !== 'tasmota') return;
            
            const r = parseInt(document.getElementById('range-R').value).toString(16).padStart(2, '0');
            const g = parseInt(document.getElementById('range-G').value).toString(16).padStart(2, '0');
            const b = parseInt(document.getElementById('range-B').value).toString(16).padStart(2, '0');
            const w = parseInt(document.getElementById('range-W').value).toString(16).padStart(2, '0');
            
            const hexColor = `${r}${g}${b}${w}`;
            try {
                await fetch(`http://${DEVICES[currentKey].host}/cm?cmnd=Color%20${hexColor}`);
            } catch (e) { console.error("Errore invio colore"); }
        }

        function updateToggleUI(isOn) {
            const btn = document.getElementById('main-toggle');
            btn.innerText = isOn ? "LUCI ACCESE" : "LUCI SPENTE";
            btn.className = `w-full py-3 rounded-2xl text-[11px] font-black uppercase tracking-[0.2em] border border-white/10 ${isOn ? 'toggle-on' : 'toggle-off'}`;
        }

        async function toggleRelay() {
            const dev = DEVICES[currentKey];
            const url = dev.type === 'shelly' ? `http://${dev.host}/rpc` : `http://${dev.host}/cm?cmnd=Power%20Toggle`;
            const body = dev.type === 'shelly' ? JSON.stringify({id:1, method:"Switch.Toggle", params:{id:0}}) : null;
            try {
                const res = await fetch(url, { method: dev.type === 'shelly' ? 'POST' : 'GET', body });
                const data = await res.json();
                updateToggleUI(dev.type === 'shelly' ? !data.result.was_on : data.POWER === "ON");
            } catch (e) { console.error(e); }
        }

        async function applySettings() {
            // ... (Logica di salvataggio identica al messaggio precedente)
            document.getElementById('status-msg').innerText = "INVIO PROGRAMMAZIONE...";
            setTimeout(() => { document.getElementById('status-msg').innerText = "SALVATO"; }, 1000);
        }

        window.onload = () => switchDevice('driveway');
    </script>
</body>
</html>