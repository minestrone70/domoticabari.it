<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driveway & Ingresso | Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #050505; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .card { background: #111; border: 1px solid #222; border-radius: 28px; transition: all 0.3s ease; }
        .input-dark { background: #1a1a1a; border: 1px solid #333; color: white; border-radius: 12px; }
        .tab-active { background: #3b82f6; color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
        .btn-save { background: #3b82f6; transition: all 0.2s; }
        .btn-save:hover { background: #2563eb; transform: translateY(-1px); }
        .hidden { display: none; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="max-w-md w-full">
        <nav class="flex flex-wrap gap-2 p-1.5 bg-white/5 rounded-2xl mb-6">
            <button onclick="switchDevice('driveway')" id="btn-driveway" class="flex-1 min-w-[100px] py-3 rounded-xl text-[10px] font-bold uppercase tracking-wider transition-all tab-active">
                Driveway
            </button>
            <button onclick="switchDevice('ingresso')" id="btn-ingresso" class="flex-1 min-w-[100px] py-3 rounded-xl text-[10px] font-bold uppercase tracking-wider transition-all text-slate-500">
                Ingresso
            </button>
            <button onclick="switchDevice('chestnut')" id="btn-chestnut" class="flex-1 min-w-[100px] py-3 rounded-xl text-[10px] font-bold uppercase tracking-wider transition-all text-slate-500">
                Chestnut Hill
            </button>
        </nav>

        <div class="card p-8 shadow-2xl space-y-8 relative overflow-hidden">
            <div id="loading-overlay" class="absolute inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center hidden z-10">
                <div class="flex flex-col items-center gap-2">
                    <div class="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    <span class="text-blue-400 text-xs font-medium uppercase tracking-widest">Sincronizzazione</span>
                </div>
            </div>

            <header>
                <h2 id="display-name" class="text-2xl font-bold text-white tracking-tight text-center">Luci Driveway</h2>
                <p id="display-host" class="text-[9px] font-mono text-blue-500/40 text-center uppercase mt-1 tracking-widest"></p>
            </header>
            
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-xs font-bold uppercase tracking-[0.2em] text-slate-500">Accensione</h3>
                    <span class="text-yellow-500/50 text-lg">☼</span>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <select id="on_type" class="input-dark p-4 text-sm outline-none">
                        <option value="sun">Al Tramonto</option>
                        <option value="time">Ora Fissa</option>
                    </select>
                    <input id="on_time" type="time" class="input-dark p-4 text-sm hidden">
                </div>
            </div>

            <div class="space-y-4 pt-4 border-t border-white/5">
                <div class="flex items-center justify-between">
                    <h3 class="text-xs font-bold uppercase tracking-[0.2em] text-slate-500">Spegnimento</h3>
                    <span class="text-blue-500/50 text-lg">☾</span>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <select id="off_type" class="input-dark p-4 text-sm outline-none">
                        <option value="time" selected>Ora Fissa</option>
                        <option value="sun">All'Alba</option>
                    </select>
                    <input id="off_time" type="time" value="01:00" class="input-dark p-4 text-sm">
                </div>
            </div>

            <button onclick="applySettings()" class="w-full btn-save py-5 rounded-2xl font-bold text-white shadow-lg uppercase text-xs tracking-widest">
                Salva Configurazione
            </button>

            <div id="status" class="text-center text-[10px] font-bold uppercase tracking-widest min-h-[1.5em] mt-2"></div>
        </div>
    </div>

    <script>
        // CONFIGURAZIONE DISPOSITIVI
        const DEVICES = {
            driveway: { name: "Luci Driveway", host: "shellyplus1-08b61fcfed68.local" },
            ingresso: { name: "Luci Ingresso", host: "shellyplus1-ingresso.local" },
            chestnut: { name: "Luci Chestnut Hill", host: "shellyplus1-chestnut.local" }
        };

        let currentDevice = 'driveway';

        // Logica interfaccia
        document.getElementById('on_type').onchange = (e) => document.getElementById('on_time').classList.toggle('hidden', e.target.value === 'sun');
        document.getElementById('off_type').onchange = (e) => document.getElementById('off_time').classList.toggle('hidden', e.target.value === 'sun');

        function switchDevice(key) {
            currentDevice = key;
            document.getElementById('display-name').innerText = DEVICES[key].name;
            document.getElementById('display-host').innerText = DEVICES[key].host;
            
            // Aggiorna stile bottoni menu
            Object.keys(DEVICES).forEach(k => {
                const btn = document.getElementById(`btn-${k}`);
                if(k === key) {
                    btn.className = 'flex-1 min-w-[100px] py-3 rounded-xl text-[10px] font-bold uppercase tracking-wider transition-all tab-active';
                } else {
                    btn.className = 'flex-1 min-w-[100px] py-3 rounded-xl text-[10px] font-bold uppercase tracking-wider transition-all text-slate-500 hover:text-white';
                }
            });
            
            loadConfig();
        }

        async function api(method, params) {
            const url = `http://${DEVICES[currentDevice].host}/rpc`;
            const res = await fetch(url, { 
                method: 'POST', 
                body: JSON.stringify({ id: 1, method, params }), 
                signal: AbortSignal.timeout(4000) 
            });
            return res.json();
        }

        async function loadConfig() {
            const overlay = document.getElementById('loading-overlay');
            const status = document.getElementById('status');
            overlay.classList.remove('hidden');
            status.innerText = "";
            
            try {
                const data = await api("Schedule.List");
                data.result.jobs.forEach(job => {
                    const prefix = job.id === 1 ? 'on' : 'off';
                    const isSun = job.timespec.includes('@');
                    document.getElementById(`${prefix}_type`).value = isSun ? 'sun' : 'time';
                    const timeInput = document.getElementById(`${prefix}_time`);
                    
                    if(!isSun) {
                        const p = job.timespec.split(' ');
                        timeInput.value = `${p[2].padStart(2,'0')}:${p[1].padStart(2,'0')}`;
                        timeInput.classList.remove('hidden');
                    } else {
                        timeInput.classList.add('hidden');
                    }
                });
            } catch (e) {
                status.innerText = "OFFLINE: " + DEVICES[currentDevice].host;
                status.className = "text-center text-[10px] font-bold uppercase tracking-widest text-red-500/80";
            } finally {
                overlay.classList.add('hidden');
            }
        }

        async function applySettings() {
            const status = document.getElementById('status');
            status.innerText = "Invio...";
            status.className = "text-center text-[10px] font-bold uppercase tracking-widest text-blue-400 animate-pulse";
            
            try {
                const getCron = (prefix, sunMode) => {
                    if (document.getElementById(`${prefix}_type`).value === 'sun') return `${sunMode} * * SUN,MON,TUE,WED,THU,FRI,SAT`;
                    const [h, m] = document.getElementById(`${prefix}_time`).value.split(':');
                    return `0 ${parseInt(m)} ${parseInt(h)} * * SUN,MON,TUE,WED,THU,FRI,SAT`;
                };

                await api("Schedule.Update", { id: 1, enable: true, timespec: getCron('on', '@sunset'), calls: [{method:"Switch.Set", params:{id:0, on:true}}]});
                await api("Schedule.Update", { id: 2, enable: true, timespec: getCron('off', '@sunrise'), calls: [{method:"Switch.Set", params:{id:0, on:false}}]});
                
                status.innerText = "Configurazione Salvata";
                status.className = "text-center text-[10px] font-bold uppercase tracking-widest text-green-500 bg-green-500/5 py-2 rounded-xl mt-2";
            } catch (e) {
                status.innerText = "Errore di Connessione";
                status.className = "text-center text-[10px] font-bold uppercase tracking-widest text-red-500";
            }
        }

        window.onload = () => switchDevice('driveway');
    </script>
</body>
</html>